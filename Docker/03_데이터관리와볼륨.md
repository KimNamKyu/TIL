# 데이터 관리 및 볼륨으로 작업하기

이미지와 컨테이너 내부의 데이터를 관리하는 방법을 살펴보자!

## 데이터 카테고리 / 다양한 종류의 데이터 이해하기

이미지는 읽기전용이기 때문에 컨테이너가 삭제되면 파일시스템들을 동작하지 않고 삭제된다.

**해결책은 무엇일까?**

> 도커에는 볼륨이라는 내장기능이 있다. > 볼륨은 데이터를 유지하도록 도운다.

**볼륨이 무엇이며 동작원리는 무엇일까?**

> 볼륨은 호스트 머신의 폴더이다. 컨테이너나 이미지에 있는게 아니다.  
> 즉, 호스트 컴퓨터에 장착된 하드 드라이브에 존재하여 사용가능하거나, 컨테이너로 매핑되는 것을 의미한다. 즉, 볼륨은 도커가 인식하는 호스트 머신인 여러분의 컴퓨터에 있는 폴더로서 도커 컨테이너 내부의 폴더에 매핑된다.  
> 컨테이너 내부의 폴더를 호스트 머신 상의 컨테이너 외부 폴더에 연결할 수 있다. 그리고 두 폴더의 변경 사항은 다른 폴더에 반영된다. 따라서 호스트 머신에 파일을 추가하면 컨테이너 내부에서 액세스할 수 있고 컨테이너가 매핑된 경로에 파일을 추가하면 컨테이너 외부 즉, 호스트 머신에서도 사용할 수 있다. 볼륨을 통해 데이터를 유지시킬수 있는 원리이다.  
> 볼륨은 컨테이너가 종료된 경우에도 유지된다.

컨테이너에 볼륨을 추가하는 방법

VOLUME 명령을 추가하는 방법

`VOLUME [""]`

```
FROM node:14

WORKDIR /app

COPY package.json .

RUN npm install

COPY . .

EXPOSE 80

VOLUME [ "/app/feedback" ]  # 익명 볼륨 명령

CMD ["node", "server.js"]
```

`/app/feedback` 이 내 컨테이너 내부의 경로 이다. 컨테이너 외부 폴더에 매핑되어질 내 컨테이너 내부 위치이며, 데이터가 생존할 위치이다.

### 명명역역 볼륨 사용하기

도커에서 두가지의 외부 데이터 저장 메커니즘이 있다.

- 볼륨
- 바인드 마운트

익명영역의 볼륨을 사용하는 경우

명명된 볼륨을 할당하는 경우

두경우 모두 도커는 일부 폴더와 경로를 호스트 머신에 설정한다.

익명볼륨을 사용하였기 때문에 컨테이너가 존재하는 동안에만 실제로 존재한다. 익명볼륨은 도커에서 관리하기 때문!

명명된(named)볼륨을 사용하면 컨테이너가 종료된 후에도 볼륨을 유지된다. 즉, 하드 드라이브의 폴더에 유지되며 새 컨테이너를 시작하면 볼륨이 복구되고 폴더가 복구되어 해당 폴더에 저장된 모든 데이터를 계속 사용할 수 있다.

`docker run -d -p 3000:80 --rm --name feedback-app -v feedback:/app/feedback feedback-node:volumes`

-v [볼륨명명: 컨테이너 내부 경로]

익명볼륨과의 차이점은 컨테이너가 종료되더라도 도커에 의해 볼륨이 삭제되지 않는다는 것이다.

### 익명 볼륨 제거하기

`docker volume rm VOL_NAME`

`docker volume prune`

### 바인드 마운트 시작하기

우리가 직면할수 있는 문제

소스코드에서 무엇이든 변경할 때마다, 이미지를 다시 빌드 하지 않는 한 이러한 변경 사항은 실행 중인 컨테이너에 반영되지 않는다.

도커 이미지가 생성될 때 이들 폴더의 스냅샷만 복사하기 때문에 해당 폴더의 모든 항목에 대한 미래의 변경사항은 이미지에 반영되지 않는다.

바인드 마운트는 호스트 머신 상에 매핑될 컨테이너의 경로를 설정하기 때문에 우리는 로컬 호스트 머신 상의 경로를 인식할 수 있다.

컨테이너는 볼륨에 쓸 수 있을 뿐만 아니라, 볼륨에서 읽을 수도 있기에 소스코드를 바인드 마운트에 넣을 수 있다. 컨테이너는 이를 인식하여 소스 코드를 실제로 스냅샷에서 복사하는 것이 아니라 바인딩 마운트에서복사한다. 그 폴더는 호스트 머신의 어떤 폴더에 연결되어 항상 최신의 소스코드를 볼수 있다.

바인드 마운트 : 영구적이고 편집가능한 데이터에 적합하다.

명명된 볼륨 : 영구 데이터에 도움이 되지만 편집은 불가능하다.(호스트 머신 어디에 저장되어 있는지 모르기 때문)

도커파일 내부에서 할수 있는것이 아니다. 실제로 이미지가 아니라 실행하는 컨테이너에만 적용되기 때문이다. 터미널 내부에서 바인드 마운트를 설정해야 한다.

`docker run -d -p 3000:80 --rm --name feedback-app -v feedback:/app/feedback -v "/Users/southkyu/Downloads/data-volumes-01-starting-setup:/app" -v /app/node-modules feedback-node:volumes`

macOS / Linux: `-v $(pwd):/app`

COPY . . npm install 하기 때문에 기존에 설치된 노드모듈들은 볼륨을 설정해주자

그럼 소스코드를 수정하더라도 컨테이너에 반영가능하다

| 익명 볼륨                              | 명명 볼륨                                                                   | 바인딩 마운트                                                                                                                                |
| -------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| 컨테이너에 연결된 일좀의 볼륨을 생성   | 도커파일에서 생성할수 없고 컨테이너를 실행할때 -v 명령으로 생성한다.        | 다수의 컨테이너에 연결할 수 있으며 컨테이너 종료 및 제거 후에도 유지된다. 실제로 호스트 머신에서 삭제해야한다. 도커 명령으로 제거 할수 없다. |
| 컨테이너가 제거되면 볼륨 역시 제거     | 특정 컨테이너에 연결되어 있지 않아 컨테이너를 종료하거나 제거해도 살아있다. | 컨테이너 간의 공유가 가능하다.                                                                                                               |
| 컨테이너 간에 데이터를 공유할 수 없다. | 여러 컨테이너 간에 데이터를 공유할수 있다.                                  |                                                                                                                                              |

### 읽기 전용 볼륨 살펴보기
