# Docker이미지 & 컨테이너: 코어 빌딩 블록

[도커 이미지 빌드 컨테이너 실행하기](#도커-이미지-빌드-컨테이너-실행하기)  
[도커 이미지는 읽기 전용이다.](#도커-이미지는-읽기-전용이다)  
[도커 이미지 레이어 이해하기](#도커-이미지-레이어-이해하기)  
[Attached & Detached 컨테이너 이해하기](#attached--detached-컨테이너-이해하기)  
[인터렉티브모드로 들어가기](#인터렉티브모드로-들어가기)

# 도커 이미지 빌드 컨테이너 실행하기

> 컨테이너는 애플리케이션, 웹사이트 노드서버 애플리케이션을 실행하는 전체환경 등 무엇이든 포함하는 작은 유닛이다.  
> 컨테이너는 이미지를 기반으로 하나의 인스턴스를 생성한다.

1. 도커파일 작성

```bash
FROM node  # node 이미지를 다운받아.

WORKDIR /app  #컨테이너 내부 작업디렉토리를 /app 로 설정

COPY . /app # 현재 도커파일이 작성된 전체경로를 컨테이너내부 /app 디렉토리에 카피한다.

RUN npm install # npm 설치

EXPOSE 80 # 포트 80으로 설정

CMD ["node", "server.js"] # 컨테이너 내부에서 노드를 실행
```

2. 도커 이미지 빌드

`docker build .` : 현재 도커파일이 존재하는 경로를 설정 도커이미지를 빌드한다.

3. 도커 컨테이너 실행

`docker run -p 3000:80 [Image]` : 로컬포트 3000번과 컨테이너 내부 80포트를 연결시켜준다.

# 도커 이미지는 읽기 전용이다.

NOTE: 간단한 코드 수정 후 컨테이너를 멈추고 재 실행하면 코드가 정상적으로 반영되어 있지 않다. 왜 그럴까? `이미지가 작동하는 방식`을 이해 해야한다. 소스코드인 노드 애플리케이션 코드의 일부임을 명심하자! 이 코드로 `도커파일`에서 도커에게 마지막으로 내 소스코드를 컨테이너 파일 시스템에 보관하는 server.js 파일을 포함하여 프로젝트 폴더 내의 모든것을 `app폴더에 복사`하도록 지시한다.
`소스 코드의 변경사항이 있으면 이미지의 소스 코드에 포함되지 않는다.`

업데이트된 소스 코드를 새 이미지로 복사하려면 이미지를 다시 빌드해야 한다.

도커이미지를 다시 빌드하고 컨테이너를 실행하면 소스코드의 변경사항을 확인할수 있다. 이게 이미지가 읽기 전용이라는 것의 핵심이다.

# 도커 이미지 레이어 이해하기

레이어 기반이란? 즉, 이미지를 빌드하거나 이미지를 다시 빌드할떄 변경된 부분의 명령과 그 이후의 모든 명령이 재평가된다.

`docker build .` 를 재실행하면 매우 빠르게 완료된다. 빌드 로그에서 `CACHED`를 확인할수있다. 도커는 이미지를 빌드할때마다 모든 명령결과를 캐시하고 이러한 캐시된 결과를 사용한다. 이것이 레이어 기반 아키텍쳐이다.

```bash
#최적화

FROM node

WORKDIR /app

COPY package.json /app

RUN npm install

COPY . /app

EXPOSE 80

CMD ["node", "server.js"]
```

package.json을 먼저 카피하면 소스코드가 변경사항이 있더라도 npm install를 하지 않아 최적화 할수 있다.

# Attached & Detached 컨테이너 이해하기

`docker run` 은 이미지를 기반으로 새 컨테이너를 만들고 그 이후에 새 컨테이너가 시작된다. frontgrade방식으로 실행되어 터미널을 입력할수 없다. (attached모드)

`docker start` 로 기존 컨테이너를 다시 시작할수있다. (dettached 모드) background로 실행된다.

도커 실행시 `-d` 플래그르 통해 Detached모드로 실행할수있다.

detached모드에서 실행된 컨테이너의 로그를 확인하기 위해 `logs` 명령어를 통해 확인할수 있다.

# 인터렉티브모드로 들어가기

`-i` — interactive 컨테이너에 무언가를 입력할수잇다.

# 이미지 & 컨테이너 삭제하기

`docker image prune` 사용되지않는 도커 이미지들을 제거해준다.

중지된 컨테이너를 자동 제거하기

`docker run -p 3000:80 -d --rm [image]` : —rm 명령어를 통해 도커 컨테이너가 멈추게되면 자동으로 컨테이너를 제거해준다.

# 컨테이너에 / 컨테이너로 부터 파일 복사하기

컨테이너를 살펴보거나 컨테이너를 중지하지 않고 파일을 복사할수 있다.

`docker cp [conarinerId]:/test dummy` : `cp` 명령을 통해 컨테이너에서 로컬로 로컬에서 컨테이너로 파일을 복사할수 있다.

# 컨테이너와 이미지에 이름 지점 & 태그 지정

`—name` 태그를 통해 이름을 지정할수 있다.

ex) `docker run -p 3000:80 -d --rm --name nodeapp [imageId]

이미지 태그 지정

`docker build -t goals:latest .`

# 도커 이미지 공유하기

도커이미지를 공유하는 방법에는 두가지가 있다.

- 도커파일을 공유하는 방법
- 빌드된 도커 이미지를 공유하는 방법

# 도커 허브에 이미지 푸시

완성된 이미지를 어떻게 공유할수 있을까?

이미지 공유를 위한 내장된 명령이 있다. 이미지를 공유할때 이미지를 푸시 할수 있는 두가지 주요 위치가 있다.

도커 허브 / Private Registry

도커 허브 > 레포생성 > **`docker push southkyu/node-hello-app` CLI 실행**

# 공유 이미지 가져오기(pull) & 사용하기

`docker pull southkyu/node-hello-app`

도커 풀을 실행하면 항상 컨테이너 레지스트리에서 최신 이미지를 가져온다.
